# 2025-09-18 改善案

## 現状評価
- **生成品質**: slot 分割とプロンプト駆動のワークフローにより、一定水準以上の記事体裁と構造化されたアウトラインを継続的に生成できている。
- **技術基盤**: `src/main.py` と `src/enhanced_main.py` を入口にした二層パイプライン構造が明確で、ローカル処理と AI 強化処理を分離できている。
- **資産活用**: 既存のプロンプト群やテンプレート、アナライザークラスが整備されており、追加の観点を差し込みやすい。

## 課題認識
- **安定性**: PDF レイアウト差異やテキスト抽出失敗時の挙動が限定的で、例外時のフォールバックや再試行ロジックが脆弱。AI 呼び出しもタイムアウト／レートリミットに対するリカバリ設計が不足。
- **専門性・独自性**: Slot ごとのプロンプトは存在するが、業界別／会計トピック別の深掘りには定型記述が多く、独自の指標算出や外部データ参照がないため差別化が難しい。
- **記事体験**: 画像貼り付けや引用は行えているものの、キャプション生成やハイライト領域の明示がなく、図表と本文の対応関係が曖昧。読者視点のナビゲーションが不足。
- **検証・監視**: 実行ログは最小限で、各ステージの成功判定や品質メトリクスが残っていない。リグレッションテストや自動検収の仕組みも未整備。

## 改善方針
1. **堅牢な抽出基盤の構築**
   - PDF 読み込みからテキスト抽出までをステージ化し、失敗時のフォールバック（例: DPI 変更・ページ単位の再レンダリング・OCR 呼出し）を明示的に設計。
   - `pdf_utils.py` にリトライ可能なラッパーを実装し、処理履歴とエラー種別を `logs/` に蓄積。対象 PDF のメタ情報と紐付ける。
   - レイアウト解析（表/段組）を補助する軽量ルールを導入し、アナライザー側で構造化された入力を扱えるようにする。

2. **アナライザーとプロンプトの専門化**
   - Slot クラスに業界タグ／決算種別（本決算・四半期・短信）をインプットし、プロンプトと前処理を切り替えるフックを追加。
   - KPI・セグメント・財務健全性などの定量項目は、抽出値を統計的に補正・比較する仕組み（過去四半期との差分、成長率、予算比）を組み込み、AI 応答に具体値を渡して差別化。
   - リスク評価など定性的 Slot には、正規表現ベースのスニペット抽出 + AI に要約させる二段構成を採用し、引用箇所と文章の対応を強化。

3. **AI 呼び出しの信頼性向上**
   - `ai_client.py` にレートリミット検知・指数バックオフ・部分リトライを導入し、プロンプト→レスポンスまでのタイムラインを計測。
   - プロンプト管理をバージョン化し、`prompt_loader.py` でファイルハッシュとスキーマ検証を行う。破損や差し替えを検出して警告ログを出力。
   - 異常応答（トークン欠落・JSON 形式崩れ）を検出するバリデーション層を設け、Slot 結果にフェイルセーフのメッセージを付与。

4. **記事生成体験の向上**
   - `ImageMatcher` を拡張して、引用画像のキャプション・ハイライト座標・該当ページ内セクション名を返却。Markdown 側で「図表 x: ○○」形式へ整形。
   - 章構成テンプレートを増やし、要約・本論・投資判断・ Q&A など複数フォーマットに対応。読者の関心別に出力を切り替えるパラメータを追加。
   - 重要指標は表形式で出力し、チャート生成（例: Matplotlib で簡易棒グラフ）をオプションで追加。視覚的な訴求力と比較性を高める。

5. **品質保証と監視ライン**
   - スクリプト全体をモジュールテストできるよう、`tests/` に PDF モック + 期待出力スナップショットを用意。pytest + golden file でリグレッションを検出。
   - 実行ログに KPI（処理時間、抽出成功率、AI コール数）を残し、閾値逸脱で通知する仕組み（ローカルでもファイル監視ベース）を導入。
   - Slot ごとの品質指標（引用数、本文 vs. AI 生成比率、固有名詞抽出数など）を算出し、結果 JSON に埋め込んで品質トラッキング。

## ロードマップ案
| フェーズ | 期間目安 | 主な成果物 | 依存関係 |
|---------|---------|------------|----------|
| Phase 0 | 1 週間  | エラーハンドリング整備、ログ拡張 | 既存コード調査完了 |
| Phase 1 | 2–3 週間 | Slot 専門化（業界タグ、定量値補強）、バリデーション実装 | Phase 0 |
| Phase 2 | 2 週間  | テンプレート拡張、画像キャプション/可視化機能 | Phase 1 |
| Phase 3 | 継続    | 自動テスト・品質指標ダッシュボード整備 | 全フェーズ |

## 成果指標サンプル
- PDF 処理失敗率 < 1%（現在不明 → ログ蓄積で測定開始）
- AI 応答の整形失敗率 < 3%、Slot エラーフォールバックでゼロ落ち防止
- 主要 KPI の抽出成功率 90% 以上（業界別ルール導入後に計測）
- 記事閲覧時のスクロール率・滞在時間（将来的に配信プラットフォームと連携）

## 今後の検討余地
- 業界別サマリのテンプレート化と、外部統計データ（市場規模・競合指標）の自動引用
- 画像ハイライトから自動でテキストボックスを抽出し、グラフ読み取り支援ツールを付加
- パイプライン全体をモジュール化して他サービスへの横展開を可能にする CLI/API 化

以上の改善群により、既存の生成品質を維持しつつ安定性・専門性・読者体験を押し上げ、継続的に改善可能な堅牢基盤を構築できます。
